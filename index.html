<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠a M2T: Sistemas de Seguridad Electr√≥nica (UT1 y UT9)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Iconos Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/umd/phosphor-icons.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        
        /* Estilos de Pesta√±a Principal */
        .main-nav-link {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: #4b5563;
        }
        .main-nav-link.active {
            border-bottom-color: #10b981; /* Esmeralda */
            color: #10b981;
            font-weight: 600;
            background-color: #ecfdf5;
        }
        .main-content-section {
            display: none;
        }
        .main-content-section.active {
            display: block;
        }

        /* Estilos de Pesta√±a Secundaria (UT9) */
        .sub-nav-link {
            transition: color 0.2s, background-color 0.2s;
            border-radius: 9999px; /* Pill shape */
            padding: 8px 16px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: #4b5563;
        }
        .sub-nav-link.active {
            background-color: #34d399; /* Emerald 400 */
            color: #064e3b; /* Emerald 900 */
            font-weight: 600;
        }
        
        .info-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .llm-feature {
            background-color: #fff7ed; /* Orange 50 */
            border: 2px solid #fdba74; /* Orange 300 */
        }
        .llm-title {
            color: #ea580c; /* Orange 600 */
        }

        /* Nuevo estilo para Markdown */
        .markdown-content {
            white-space: pre-wrap; /* Mantiene saltos de l√≠nea y espacios */
        }
        .markdown-content ul {
            list-style-type: none; /* Quitamos los puntos de lista del renderizador de markdown */
            padding-left: 0; 
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content li {
            margin-bottom: 0.25rem;
        }

        /* Estilos para Tablas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            font-size: 0.875rem; /* text-sm */
        }
        .data-table th, .data-table td {
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 0.75rem;
            text-align: left;
        }
        .data-table th {
            background-color: #f3f4f6; /* gray-100 */
            font-weight: 600;
            color: #374151; /* gray-700 */
        }
        .data-table tr:nth-child(even) {
            background-color: #f9fafb; /* gray-50 */
        }

        /* Estilo para la barra de progreso de Grados */
        progress {
            /* Estilo base */
            appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            background-color: #e5e7eb; /* Fondo gris claro */
        }

        progress::-webkit-progress-bar {
            background-color: #e5e7eb;
        }

        progress::-webkit-progress-value {
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        progress.grade-1::-webkit-progress-value { background-color: #22c55e; } /* Verde - Bajo */
        progress.grade-2::-webkit-progress-value { background-color: #f97316; } /* Naranja - Medio */
        progress.grade-3::-webkit-progress-value { background-color: #dc2626; } /* Rojo - Alto */
        progress.grade-4::-webkit-progress-value { background-color: #4b5563; } /* Gris Oscuro - M√°ximo */

        .flex-center {
            display: flex;
            align-items: center;
        }
        
    </style>
</head>
<body class="text-gray-800">

    <!-- CONTENIDO PRINCIPAL (ACCESO DIRECTO) -->
    <div id="main-content" class="w-full max-w-6xl mx-auto p-4 md:p-8">
        <header class="text-center mb-10 bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Gu√≠a M2T: Sistemas de Seguridad Electr√≥nica</h1>
            <p class="mt-2 text-lg text-gray-600">Documentaci√≥n de las Unidades Tem√°ticas 1 y 9.</p>
        </header>

        <!-- NAVEGACI√ìN PRINCIPAL (UT1 vs UT9) -->
        <nav class="flex justify-center border-b border-gray-300 mb-8 overflow-x-auto whitespace-nowrap bg-white rounded-t-xl shadow-inner">
            <button class="main-nav-link py-4 px-4 sm:px-6 text-base sm:text-lg active" data-target="ut1">UT1: Introducci√≥n y Componentes</button>
            <button class="main-nav-link py-4 px-4 sm:px-6 text-base sm:text-lg" data-target="ut9">UT9: Normativa y PRL</button>
        </nav>

        <main class="bg-white p-6 md:p-10 rounded-b-xl shadow-lg">
            
            <!-- SECCI√ìN 1: UT1 - INTRODUCCI√ìN Y COMPONENTES (Contenido Ampliado) -->
            <section id="ut1-section" class="main-content-section active">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2 flex-center justify-center"><i class="ph ph-shield-check-fill text-3xl mr-2 text-green-500"></i> UT1: Sistemas de Seguridad Electr√≥nica üõ°Ô∏è</h2>
                    <p class="max-w-4xl mx-auto text-gray-600">Conjunto de equipos y componentes para la protecci√≥n de personas y bienes. La variaci√≥n de los sistemas depende de las <strong>necesidades del usuario</strong>, las <strong>caracter√≠sticas del recinto</strong> y el <strong>presupuesto</strong>.</p>
                </div>

                <!-- 1. CLASIFICACI√ìN -->
                <h3 class="text-xl font-bold mb-4 text-blue-600 border-b pb-2 flex-center"><i class="ph ph-list-numbers-fill mr-2"></i> 1. Clasificaci√≥n de Sistemas de Seguridad Electr√≥nica üè∑Ô∏è</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="info-card p-4 rounded-lg border-l-4 border-indigo-500 bg-indigo-50">
                        <h4 class="font-bold text-lg text-indigo-700 flex-center"><i class="ph ph-factory-fill mr-2 text-xl"></i> Seguridad de las Instalaciones üè¢</h4>
                        <ul class="list-disc list-inside text-sm text-gray-700 pl-2 space-y-2">
                            <li><span class="font-semibold">Sistemas Contra Incendio:</span> Localizar, dar aviso y accionar <strong class="text-red-600">extinci√≥n autom√°tica</strong>.</li>
                            <li><span class="font-semibold">Sistemas de Detecci√≥n de Gas:</span> Alerta sobre riesgo de <strong class="text-red-600">explosi√≥n, intoxicaci√≥n o asfixia</strong>.</li>
                        </ul>
                    </div>
                    <div class="info-card p-4 rounded-lg border-l-4 border-purple-500 bg-purple-50">
                        <h4 class="font-bold text-lg text-purple-700 flex-center"><i class="ph ph-lock-key-fill mr-2 text-xl"></i> Seguridad Privada üîë</h4>
                        <ul class="list-disc list-inside text-sm text-gray-700 pl-2 space-y-2">
                            <li><span class="font-semibold">Sistemas Antirrobo e Intrusi√≥n:</span> Advierte de allanamiento. Incluye <strong>Control de Presencia</strong> y <strong class="text-purple-700">Control de Accesos</strong> (gesti√≥n de entrada/salida).</li>
                            <li><span class="font-semibold">Circuito Cerrado de Televisi√≥n (CCTV):</span> <strong class="text-purple-700">Videovigilancia</strong> para disuasi√≥n y prueba forense.</li>
                        </ul>
                    </div>
                </div>

                <!-- 2. GRADOS DE SEGURIDAD (Con Perfil de Sabotaje) -->
                <h3 class="text-xl font-bold mb-4 text-red-600 border-b pb-2 flex-center"><i class="ph ph-star-fill mr-2"></i> 2. Grados de Seguridad (UNE-EN 50131-1) ‚≠ê</h3>
                <p class="text-gray-700 mb-4">Los grados definen el nivel de riesgo y los requisitos m√≠nimos del sistema, bas√°ndose en el <strong>valor a proteger</strong> y la <strong>capacidad del intruso</strong> para eludirlo.</p>

                <div class="overflow-x-auto rounded-lg shadow-md mb-8">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="w-1/12 bg-red-100">Grado</th>
                                <th class="w-3/12 bg-red-100">Nivel de Riesgo y Robustez</th>
                                <th class="w-4/12 bg-red-100">Perfil del Sabotaje (Probabilidad)</th>
                                <th class="w-2/12 bg-red-100">Conexi√≥n a CRA</th>
                                <th class="w-2/12 bg-red-100">Visualizaci√≥n de Robustez</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold text-red-600">Grado 1</td>
                                <td>Bajo (Sistemas disuasorios)</td>
                                <td><strong>Muy poco probable</strong> que se intente eludir.</td>
                                <td>No obligatoria.</td>
                                <td><progress class="grade-1" value="1" max="4"></progress></td>
                            </tr>
                            <tr>
                                <td class="font-bold text-orange-600">Grado 2</td>
                                <td>Bajo-Medio (Viviendas y Comercios)</td>
                                <td><strong>Poco probable</strong> el intento de eludir.</td>
                                <td>Opcional / Requerida.</td>
                                <td><progress class="grade-2" value="2" max="4"></progress></td>
                            </tr>
                            <tr>
                                <td class="font-bold text-yellow-700">Grado 3</td>
                                <td>Medio-Alto (Riesgo Alto)</td>
                                <td><strong>Probable</strong> que se intente eludir o sabotear. <strong class="text-yellow-700">Doble v√≠a de comunicaci√≥n</strong> obligatoria.</td>
                                <td><strong>Obligatoria</strong>.</td>
                                <td><progress class="grade-3" value="3" max="4"></progress></td>
                            </tr>
                            <tr>
                                <td class="font-bold text-gray-700">Grado 4</td>
                                <td>Alto (M√°xima Seguridad)</td>
                                <td><strong>Muy probable</strong> el sabotaje con herramientas y t√©cnicas especializadas.</td>
                                <td>Opcional / Requerida.</td>
                                <td><progress class="grade-4" value="4" max="4"></progress></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 3. COMPONENTES FUNDAMENTALES -->
                <h3 class="text-xl font-bold mb-4 text-green-600 border-b pb-2 flex-center"><i class="ph ph-puzzle-piece-fill mr-2"></i> 3. Componentes Fundamentales de un Sistema üß©</h3>
                
                <div class="space-y-6 mb-8">
                    <!-- A. Central -->
                    <div class="p-5 rounded-lg border-l-4 border-green-500 bg-green-50 shadow-md">
                        <h4 class="font-bold text-lg text-green-700 flex-center mb-2"><i class="ph ph-cpu-fill mr-2"></i> Central de Alarmas (Unidad de Control) üß†</h4>
                        <p class="text-sm text-gray-700 mb-2">Es el <strong>n√∫cleo</strong> que recibe, procesa y direcciona la informaci√≥n. Garantiza el <strong>funcionamiento ininterrumpido</strong> gracias a su <strong class="text-green-700">Bater√≠a de Apoyo</strong>.</p>
                        <ul class="list-disc list-inside text-xs text-gray-600 pl-4 space-y-1">
                            <li><strong>Funci√≥n Principal:</strong> Procesar la se√±al del detector y compararla con la <strong>programaci√≥n preestablecida</strong>.</li>
                        </ul>
                    </div>
                    
                    <!-- B. Entradas -->
                    <div class="p-5 rounded-lg border-l-4 border-blue-500 bg-blue-50 shadow-md">
                        <h4 class="font-bold text-lg text-blue-700 flex-center mb-2"><i class="ph ph-eye-fill mr-2"></i> Entradas del Sistema (Detectores y Pulsadores) üëÅÔ∏è‚Äçüó®Ô∏è</h4>
                        <p class="text-sm text-gray-700">Act√∫an como los <strong>"sentidos"</strong> del sistema. Miden variables f√≠sicas o detectan eventos. Trabajan a <strong>bajas tensiones (9, 12, 24, 48 Vcc)</strong>.</p>
                    </div>

                    <!-- C. Salidas -->
                    <div class="p-5 rounded-lg border-l-4 border-orange-500 bg-orange-50 shadow-md">
                        <h4 class="font-bold text-lg text-orange-700 flex-center mb-2"><i class="ph ph-megaphone-fill mr-2"></i> Salidas del Sistema (Actuadores) üì¢</h4>
                        <p class="text-sm text-gray-700 mb-2">Se encargan de <strong>ejecutar las acciones</strong> ordenadas por la central. Ejemplos:</p>
                        <ul class="list-none text-sm text-gray-600 pl-4 space-y-1">
                            <li class="flex-center"><i class="ph ph-siren-fill text-orange-600 mr-2"></i> Avisos Ac√∫sticos y √ìpticos (<strong>Sirenas, luces estrobosc√≥picas</strong>).</li>
                            <li class="flex-center"><i class="ph ph-fire-extinguisher-fill text-red-600 mr-2"></i> Sistemas de Extinci√≥n (Rociadores o agentes extintores).</li>
                            <li class="flex-center"><i class="ph ph-phone-call-fill text-blue-600 mr-2"></i> Comunicaciones (Transmisores para alarmas silenciosas o llamadas autom√°ticas).</li>
                        </ul>
                    </div>

                    <!-- D. Gesti√≥n Externa -->
                    <div class="p-5 rounded-lg border-l-4 border-teal-500 bg-teal-50 shadow-md">
                        <h4 class="font-bold text-lg text-teal-700 flex-center mb-2"><i class="ph ph-user-circle-gear-fill mr-2"></i> Central Receptora de Alarmas (CRA) üìû</h4>
                        <p class="text-sm text-gray-700">Servicio crucial operado por personal especializado **24/7** para recepci√≥n, **verificaci√≥n** (v√≠deo/audio) y gesti√≥n de alarmas a distancia, antes de avisar a <strong class="text-teal-700">Fuerzas de Seguridad</strong>.</p>
                    </div>
                </div>

                <!-- 4. MEDIOS DE COMUNICACI√ìN -->
                <h3 class="text-xl font-bold mb-4 text-indigo-600 border-b pb-2 flex-center"><i class="ph ph-link-fill mr-2"></i> 4. Medios de Comunicaci√≥n entre Componentes üîó</h3>
                
                <div class="overflow-x-auto rounded-lg shadow-md mb-8">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="w-2/12 bg-indigo-100">Tipo</th>
                                <th class="w-3/12 bg-indigo-100">Medio F√≠sico</th>
                                <th class="w-4/12 bg-indigo-100">Ventajas (Lo Positivo)</th>
                                <th class="w-3/12 bg-indigo-100">Inconvenientes y Riesgos</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-semibold text-indigo-700 flex-center"><i class="ph ph-cable-car-fill text-lg mr-2"></i> Cableados</td>
                                <td>Cable, Bus de datos, fibra √≥ptica.</td>
                                <td>M√°xima <strong>fiabilidad y robustez</strong> frente a interferencias.</td>
                                <td><strong>Instalaci√≥n m√°s costosa</strong>. Distancia limitada.</td>
                            </tr>
                            <tr>
                                <td class="font-semibold text-indigo-700 flex-center"><i class="ph ph-antenna-fill text-lg mr-2"></i> Inal√°mbricos</td>
                                <td>Infrarrojos, Radiofrecuencia (RF) encriptada.</td>
                                <td><strong>No requiere cableado</strong>, montaje m√°s f√°cil.</td>
                                <td>Mayor posibilidad de <strong>interferencias externas (inhibidores)</strong>. Necesidad de <strong class="text-red-500">bater√≠as</strong>.</td>
                            </tr>
                            <tr>
                                <td class="font-semibold text-indigo-700 flex-center"><i class="ph ph-globe-hemisphere-east-fill text-lg mr-2"></i> Comunicaci√≥n Remota</td>
                                <td>L√≠neas telef√≥nicas, m√≥vil (GSM/4G/5G), Internet (IP).</td>
                                <td>Esencial para transmitir informaci√≥n <strong>fuera del sistema local</strong> (a CRA, propietario).</td>
                                <td>Depende de la <strong>infraestructura</strong> de comunicaciones estable.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 5. EJECUCI√ìN Y MANTENIMIENTO -->
                <h3 class="text-xl font-bold mb-4 text-pink-600 border-b pb-2 flex-center"><i class="ph ph-tools-fill mr-2"></i> 5. Ejecuci√≥n, Mantenimiento y Documentaci√≥n üõ†Ô∏è</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Empresas Autorizadas -->
                    <div class="p-4 rounded-lg border-l-4 border-pink-500 bg-pink-50 shadow-md">
                        <h4 class="font-bold text-base text-pink-700 mb-1 flex-center"><i class="ph ph-certificate-fill text-lg mr-2"></i> Empresas Autorizadas ‚úÖ</h4>
                        <ul class="list-disc list-inside text-xs text-gray-700 pl-2 space-y-1">
                            <li>Instaladora/Mantenedora de <strong>Seguridad</strong>.</li>
                            <li>Instaladora/Mantenedora de <strong>Protecci√≥n Contra Incendios</strong>.</li>
                            <li>Instaladora de <strong>Telecomunicaciones</strong> (ICT).</li>
                        </ul>
                    </div>
                    <!-- Documentaci√≥n Obligatoria -->
                    <div class="p-4 rounded-lg border-l-4 border-pink-500 bg-pink-50 shadow-md">
                        <h4 class="font-bold text-base text-pink-700 mb-1 flex-center"><i class="ph ph-book-open-text-fill text-lg mr-2"></i> Documentaci√≥n Obligatoria üìú</h4>
                        <ul class="list-disc list-inside text-xs text-gray-700 pl-2 space-y-1">
                            <li>Certificado de <strong>Garant√≠a</strong> y Homologaci√≥n.</li>
                            <li>Manuales de <strong>Obra</strong> y <strong>Mantenimiento</strong>.</li>
                            <li><strong>Manual de Usuario</strong> (armar/desarmar).</li>
                        </ul>
                    </div>
                     <!-- Instrumentos Necesarios -->
                    <div class="p-4 rounded-lg border-l-4 border-pink-500 bg-pink-50 shadow-md">
                        <h4 class="font-bold text-base text-pink-700 mb-1 flex-center"><i class="ph ph-test-tube-fill text-lg mr-2"></i> Instrumentos Esenciales üî¨</h4>
                        <ul class="list-disc list-inside text-xs text-gray-700 pl-2 space-y-1">
                            <li><strong>Mult√≠metro</strong>, Medidor de tierra.</li>
                            <li>Fusionadora de fibra √≥ptica.</li>
                            <li><strong>P√©rtiga de comprobaci√≥n</strong> de detectores.</li>
                            <li>Analizador/certificador para redes.</li>
                        </ul>
                    </div>
                </div>

                <!-- Tipos de Mantenimiento (Gr√°fico y Listado) -->
                <div class="p-5 rounded-lg border-l-4 border-pink-700 bg-pink-100 shadow-lg">
                    <h4 class="font-bold text-lg text-pink-800 mb-3 flex-center"><i class="ph ph-recycle-fill mr-2"></i> Tipos de Mantenimiento (Fiabilidad del Sistema) ‚ôªÔ∏è</h4>
                    <ul class="list-none grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-gray-700 p-0">
                        <li class="flex-center">
                            <i class="ph ph-wrench-fill text-red-600 mr-2 text-xl"></i>
                            <div>
                                <span class="font-bold text-pink-900">Correctivo:</span> Solucionar una aver√≠a <strong>ya detectada</strong>.
                            </div>
                        </li>
                        <li class="flex-center">
                            <i class="ph ph-calendar-check-fill text-green-600 mr-2 text-xl"></i>
                            <div>
                                <span class="font-bold text-pink-900">Preventivo:</span> <strong>Revisiones peri√≥dicas</strong> (limpieza, calibraci√≥n). Es obligatorio.
                            </div>
                        </li>
                        <li class="flex-center">
                            <i class="ph ph-chart-line-up-fill text-blue-600 mr-2 text-xl"></i>
                            <div>
                                <span class="font-bold text-pink-900">Predictivo:</span> Usar programas para <strong>pronosticar</strong> la falla de un equipo.
                            </div>
                        </li>
                    </ul>
                </div>


                <!-- FEATURE GEMINI: EXPLICACI√ìN AVANZADA (UT1) -->
                <div class="llm-feature p-6 rounded-xl shadow-lg mt-10">
                    <h3 class="text-2xl font-bold mb-4 llm-title flex items-center">
                        <i class="ph-fill ph-sparkle text-3xl mr-2"></i> Explicaci√≥n Avanzada de Conceptos UT1
                    </h3>
                    <p class="text-gray-700 mb-4">Introduce cualquier t√©rmino relacionado con la UT1 (ej. "Detector Magn√©tico", "Doble V√≠a de Comunicaci√≥n", "Grado 4") para obtener una explicaci√≥n concisa de experto.</p>
                    
                    <!-- INPUT API KEY -->
                    <div class="mb-4 p-3 bg-white rounded-lg border border-orange-300">
                        <label for="local-api-key-ut1" class="block text-sm font-medium text-orange-700 mb-1">Clave API de Gemini (Opcional):</label>
                        <input type="text" id="local-api-key-ut1" placeholder="Pega aqu√≠ tu clave personal si est√°s usando la web localmente (o d√©jalo vac√≠o)" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm" />
                    </div>

                    <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 mb-4">
                        <input type="text" id="explanation-input" placeholder="Escribe el concepto a profundizar..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" value="Grado 3" />
                        <button id="generate-explanation-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 flex items-center justify-center">
                            Generar Explicaci√≥n
                        </button>
                    </div>

                    <div id="explanation-result" class="mt-4 p-4 min-h-[50px] bg-white rounded-lg shadow-inner border border-orange-200 text-gray-700 markdown-content">
                        <p class="text-gray-500">La explicaci√≥n generada aparecer√° aqu√≠.</p>
                    </div>
                    <div id="explanation-loader" class="hidden text-center mt-4">
                        <div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-orange-500 rounded-full" role="status"></div>
                        <span class="ml-2 text-orange-500 font-medium">Generando explicaci√≥n...</span>
                    </div>
                </div>
            </section>


            <!-- SECCI√ìN 2: UT9 - NORMATIVA Y PRL (Contenido Original, No Modificado) -->
            <section id="ut9-section" class="main-content-section">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2 flex-center justify-center"><i class="ph ph-gavel-fill text-3xl mr-2 text-red-500"></i> UT9: Normativa y Seguridad Laboral en Instalaciones</h2>
                    <p class="max-w-4xl mx-auto text-gray-600">Marco legal, fases del proyecto y prevenci√≥n de riesgos laborales esenciales.</p>
                </div>
                
                <!-- NAVEGACI√ìN SECUNDARIA DE UT9 -->
                <nav class="flex justify-center space-x-2 md:space-x-4 mb-8 bg-gray-100 p-3 rounded-xl shadow-inner">
                    <button class="sub-nav-link active" data-target="ut9-marco-legal">Marco Legal</button>
                    <button class="sub-nav-link" data-target="ut9-proyecto">Proyecto de Instalaci√≥n</button>
                    <button class="sub-nav-link" data-target="ut9-riesgos">Seguridad y PRL</button>
                </nav>

                <div id="ut9-content-container">

                    <!-- SECCI√ìN 2.1: MARCO LEGAL Y NORMATIVO -->
                    <section id="ut9-marco-legal-section" class="content-section active">
                        <h3 class="text-xl font-bold mb-4 text-emerald-600 border-b pb-2 flex-center"><i class="ph ph-file-text-fill mr-2"></i> Normativas de Aplicaci√≥n Espec√≠fica</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- Instalaciones El√©ctricas -->
                            <div class="info-card bg-gray-50 p-5 rounded-lg border-l-4 border-yellow-500 shadow-md">
                                <h4 class="text-lg font-bold mb-2 text-gray-800 flex-center"><i class="ph ph-lightning-fill text-yellow-700 mr-2"></i> Instalaciones El√©ctricas (REBT)</h4>
                                <p class="text-sm text-gray-700 leading-relaxed">
                                    Regulado por el <span class="font-semibold text-yellow-700">Reglamento Electrot√©cnico para Baja Tensi√≥n (REBT)</span>. Rige la ejecuci√≥n y seguridad de las instalaciones. El <span class="font-semibold text-yellow-700">instalador autorizado</span> debe emitir un <span class="font-semibold text-yellow-700">Certificado de Instalaci√≥n</span>.
                                </p>
                            </div>
                            
                            <!-- Telecomunicaciones -->
                            <div class="info-card bg-gray-50 p-5 rounded-lg border-l-4 border-blue-500 shadow-md">
                                <h4 class="text-lg font-bold mb-2 text-gray-800 flex-center"><i class="ph ph-broadcast-fill text-blue-700 mr-2"></i> Instalaciones de Telecomunicaciones (ICT)</h4>
                                <p class="text-sm text-gray-700 leading-relaxed">
                                    Se rigen por el <span class="font-semibold text-blue-700">Reglamento de Infraestructuras Comunes de Telecomunicaciones (ICT)</span>. Define c√≥mo deben ejecutarse los conductos, canalizaciones y las conexiones de los <span class="font-semibold text-blue-700">servicios de telecomunicaci√≥n</span>.
                                </p>
                            </div>
                        </div>

                        <!-- FEATURE GEMINI: ASESOR NORMATIVO (UT9) -->
                        <div class="llm-feature p-6 rounded-xl shadow-lg mt-10">
                            <h3 class="text-2xl font-bold mb-4 llm-title flex items-center">
                                <i class="ph-fill ph-sparkle text-3xl mr-2"></i> Asesor de Normativa y PRL (B√∫squeda Web)
                            </h3>
                            <p class="text-gray-700 mb-4">¬øPreguntas sobre una ley, un Real Decreto espec√≠fico o una medida de PRL para un trabajo concreto? Pregunta aqu√≠ para obtener una respuesta fundamentada con informaci√≥n web en tiempo real.</p>
                            
                            <!-- INPUT API KEY -->
                            <div class="mb-4 p-3 bg-white rounded-lg border border-orange-300">
                                <label for="local-api-key-ut9" class="block text-sm font-medium text-orange-700 mb-1">Clave API de Gemini (Opcional):</label>
                                <input type="text" id="local-api-key-ut9" placeholder="Pega aqu√≠ tu clave personal si est√°s usando la web localmente (o d√©jalo vac√≠o)" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm" />
                            </div>

                            <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 mb-4">
                                <input type="text" id="regulation-input" placeholder="Ej. ¬øQu√© exige el REBT para la toma de tierra de una Central?" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" value="¬øQu√© exige la Ley de Seguridad Privada para los sistemas de Grado 4?" />
                                <button id="generate-regulation-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 flex items-center justify-center">
                                    Consultar Normativa
                                </button>
                            </div>
        
                            <div id="regulation-result" class="mt-4 p-4 min-h-[50px] bg-white rounded-lg shadow-inner border border-orange-200 text-gray-700 markdown-content">
                                <p class="text-gray-500">La respuesta y sus fuentes aparecer√°n aqu√≠.</p>
                            </div>
                            <div id="regulation-loader" class="hidden text-center mt-4">
                                <div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-orange-500 rounded-full" role="status"></div>
                                <span class="ml-2 text-orange-500 font-medium">Consultando fuentes legales...</span>
                            </div>
                        </div>

                        <h3 class="text-xl font-bold mt-8 mb-4 text-emerald-600 border-b pb-2 flex-center"><i class="ph ph-folder-notch-open-fill mr-2"></i> Contexto Legal y Normas UNE</h3>
                        <ul class="list-disc list-inside space-y-2 pl-4 text-sm text-gray-700">
                            <li>La <span class="font-semibold text-gray-800">Constituci√≥n Espa√±ola</span> reconoce el derecho a la seguridad y a la intimidad (marco superior).</li>
                            <li>El <span class="font-semibold text-gray-800">C√≥digo Civil y Penal</span> regulan los da√±os y las conductas punibles.</li>
                            <li>Las <span class="font-semibold text-gray-800">Normas UNE</span> establecen los est√°ndares de calidad y <span class="font-semibold text-gray-800">compatibilidad electromagn√©tica</span> de los equipos.</li>
                        </ul>
                    </section>

                    <!-- SECCI√ìN 2.2: PROYECTO DE INSTALACI√ìN -->
                    <section id="ut9-proyecto-section" class="content-section">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex-center justify-center"><i class="ph ph-scroll-fill text-3xl mr-2 text-blue-500"></i> Fases y Contenido del Proyecto de Seguridad</h2>
                            <p class="max-w-4xl mx-auto text-gray-600">Un proyecto es el documento t√©cnico que planifica, justifica y detalla la instalaci√≥n.</p>
                        </div>

                        <h3 class="text-xl font-bold mb-4 text-emerald-600 border-b pb-2 flex-center"><i class="ph ph-flow-chart-fill mr-2"></i> Fases de Desarrollo (Proceso L√≥gico)</h3>
                        <ol class="list-decimal list-inside space-y-3 pl-4 mb-8 text-gray-700">
                            <li><span class="font-bold">Estudio Previo y Viabilidad:</span> Evaluaci√≥n de la necesidad y <span class="font-semibold text-green-700">viabilidad econ√≥mica</span>.</li>
                            <li><span class="font-bold">Recopilaci√≥n de Datos:</span> An√°lisis de riesgos y caracter√≠sticas del inmueble.</li>
                            <li><span class="font-bold">Dise√±o del Sistema:</span> Selecci√≥n de equipos, ubicaci√≥n y definici√≥n del <span class="font-semibold text-green-700">grado de seguridad</span>.</li>
                            <li><span class="font-bold">C√°lculos y Presupuesto:</span> Dimensionamiento de la alimentaci√≥n, cableado y costes.</li>
                            <li><span class="font-bold">Elaboraci√≥n de Documentaci√≥n:</span> Redacci√≥n de <span class="font-semibold text-green-700">memorias, planos</span> y pliegos de condiciones.</li>
                            <li><span class="font-bold">Ejecuci√≥n y Certificaci√≥n:</span> Instalaci√≥n, pruebas y emisi√≥n del <span class="font-semibold text-green-700">certificado final de seguridad</span>.</li>
                        </ol>

                        <h3 class="text-xl font-bold mb-4 text-emerald-600 border-b pb-2 flex-center"><i class="ph ph-package-fill mr-2"></i> Componentes Clave del Proyecto</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="info-card bg-blue-50 p-5 rounded-lg border-t-4 border-blue-600 shadow-md" onclick="showProjectDetail('memoria')">
                                <h4 class="text-lg font-bold mb-2 text-gray-800 flex-center"><i class="ph ph-pencil-simple-fill text-blue-600 mr-2"></i> 1. Memoria Descriptiva</h4>
                                <p class="text-sm text-gray-600"><span class="font-semibold">Justificaci√≥n t√©cnica</span>, normativa aplicada y descripci√≥n de la soluci√≥n.</p>
                            </div>
                            <div class="info-card bg-blue-50 p-5 rounded-lg border-t-4 border-blue-600 shadow-md" onclick="showProjectDetail('planos')">
                                <h4 class="text-lg font-bold mb-2 text-gray-800 flex-center"><i class="ph ph-map-pin-fill text-blue-600 mr-2"></i> 2. Planos y Esquemas</h4>
                                <p class="text-sm text-gray-600"><span class="font-semibold">Representaci√≥n gr√°fica</span> de la ubicaci√≥n de elementos y cableado.</p>
                            </div>
                            <div class="info-card bg-blue-50 p-5 rounded-lg border-t-4 border-blue-600 shadow-md" onclick="showProjectDetail('pliego')">
                                <h4 class="text-lg font-bold mb-2 text-gray-800 flex-center"><i class="ph ph-clipboard-text-fill text-blue-600 mr-2"></i> 3. Pliego de Condiciones</h4>
                                <p class="text-sm text-gray-600"><span class="font-semibold">Requisitos de calidad</span> de los materiales y procedimientos de prueba.</p>
                            </div>
                        </div>

                        <!-- Panel de Detalle del Proyecto -->
                        <div id="project-detail" class="mt-8 p-6 bg-yellow-50 rounded-lg shadow-inner min-h-[150px] flex items-center justify-center border-l-4 border-yellow-400">
                            <p class="text-gray-500 text-lg">Haga clic en un componente del proyecto para ver su descripci√≥n extendida.</p>
                        </div>

                        <div class="mt-8 p-5 bg-green-50 rounded-lg border-l-4 border-green-600 shadow-md">
                            <h4 class="text-lg font-bold mb-2 text-green-700 flex-center"><i class="ph ph-user-list-fill mr-2"></i> Manual de Usuario (Elemento Esencial)</h4>
                            <p class="text-sm text-gray-700 leading-relaxed">
                                Documento que debe contener la <span class="font-semibold text-green-700">descripci√≥n del funcionamiento</span>, instrucciones para <span class="font-semibold text-green-700">armar y desarmar</span>, procedimientos en caso de alarma y datos de contacto para el mantenimiento.
                            </p>
                        </div>
                    </section>

                    <!-- SECCI√ìN 2.3: SEGURIDAD Y PRL -->
                    <section id="ut9-riesgos-section" class="content-section">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex-center justify-center"><i class="ph ph-hard-hat-fill text-3xl mr-2 text-red-700"></i> Prevenci√≥n de Riesgos Laborales (PRL)</h2>
                            <p class="max-w-4xl mx-auto text-gray-600">La PRL es crucial en montaje y mantenimiento. El empresario y el trabajador tienen obligaciones espec√≠ficas.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Obligaciones -->
                            <div class="bg-red-50 p-6 rounded-lg border-l-4 border-red-600 shadow-md">
                                <h3 class="text-xl font-bold mb-4 text-red-800 flex-center"><i class="ph ph-bank-fill mr-2"></i> Obligaciones del Empresario</h3>
                                <ul class="space-y-3 text-sm text-gray-700 list-none p-0">
                                    <li class="flex-center"><i class="ph ph-shield-warning-fill text-red-600 mr-2"></i> <span class="font-semibold text-red-700">Constituir el Servicio de Prevenci√≥n</span>.</li>
                                    <li class="flex-center"><i class="ph ph-clipboard-text-fill text-red-600 mr-2"></i> <span class="font-semibold text-red-700">Evaluar los riesgos</span>.</li>
                                    <li class="flex-center"><i class="ph ph-ruler-fill text-red-600 mr-2"></i> <span class="font-semibold text-red-700">Planificar la prevenci√≥n</span>.</li>
                                    <li class="flex-center"><i class="ph ph-heartbeat-fill text-red-600 mr-2"></i> <span class="font-semibold text-red-700">Vigilancia de la salud</span>.</li>
                                    <li class="flex-center"><i class="ph ph-chalkboard-teacher-fill text-red-600 mr-2"></i> <span class="font-semibold text-red-700">Informaci√≥n y formaci√≥n</span>.</li>
                                </ul>
                            </div>

                            <!-- Derechos y Obligaciones del Trabajador -->
                            <div class="bg-teal-50 p-6 rounded-lg border-l-4 border-teal-600 shadow-md">
                                <h3 class="text-xl font-bold mb-4 text-teal-800 flex-center"><i class="ph ph-person-fill mr-2"></i> Derechos y Deberes del Trabajador</h3>
                                <ul class="space-y-3 text-sm text-gray-700 list-none p-0">
                                    <li class="flex-center"><i class="ph ph-hand-tap-fill text-teal-600 mr-2"></i> <span class="font-semibold text-teal-700">Derecho a la protecci√≥n</span> (Recibir EPIs).</li>
                                    <li class="flex-center"><i class="ph ph-check-circle-fill text-teal-600 mr-2"></i> <span class="font-semibold text-teal-700">Deber de cumplir las normas</span> (Usar correctamente los EPIs).</li>
                                    <li class="flex-center"><i class="ph ph-warning-fill text-teal-600 mr-2"></i> <span class="font-semibold text-teal-700">Informar de riesgos</span>.</li>
                                    <li class="flex-center"><i class="ph ph-users-three-fill text-teal-600 mr-2"></i> <span class="font-semibold text-teal-700">Participaci√≥n</span>.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-10">
                            <h3 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2 flex-center"><i class="ph ph-flame-fill mr-2"></i> Riesgos Cr√≠ticos y Medidas Preventivas</h3>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-orange-600">
                                    <p class="font-semibold text-lg text-gray-800 flex-center"><i class="ph ph-electric-current-fill text-orange-600 mr-2"></i> Riesgo El√©ctrico</p>
                                    <p class="text-sm text-gray-500 mt-1">Peligro por <span class="font-semibold text-orange-700">contacto con tensi√≥n</span>. Prevenci√≥n: Uso de <span class="font-semibold text-orange-700">EPIs aislantes</span> y las <span class="font-semibold text-orange-700">cinco reglas de oro</span>.</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-orange-600">
                                    <p class="font-semibold text-lg text-gray-800 flex-center"><i class="ph ph-stairs-fill text-orange-600 mr-2"></i> Ca√≠da en Altura</p>
                                    <p class="text-sm text-gray-500 mt-1">Riesgo al usar <span class="font-semibold text-orange-700">escaleras, andamios</span>. Prevenci√≥n: Uso de <span class="font-semibold text-orange-700">arn√©s de seguridad</span> anclado e <span class="font-semibold text-orange-700">inspecci√≥n</span> de equipos de acceso.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-10 p-5 bg-gray-100 rounded-lg shadow-inner">
                            <h3 class="text-xl font-bold mb-3 text-gray-700 flex-center"><i class="ph ph-trash-fill mr-2"></i> Gesti√≥n de Residuos (Medio Ambiente)</h3>
                            <p class="text-sm text-gray-600 leading-relaxed mb-3">
                                La gesti√≥n es obligatoria (<span class="font-semibold">Ley 10/1998</span>).
                            </p>
                            <ul class="list-none space-y-2 pl-0 text-sm text-gray-700">
                                <li class="flex-center"><i class="ph ph-package-fill text-gray-600 mr-2"></i> <span class="font-semibold text-gray-800">Residuos de Instalaci√≥n:</span> Escombros y embalajes a <strong class="text-gray-800">contenedores espec√≠ficos</strong>.</li>
                                <li class="flex-center"><i class="ph ph-battery-charging-fill text-gray-600 mr-2"></i> <span class="font-semibold text-gray-800">RAEE:</span> Residuos de Aparatos El√©ctricos y Electr√≥nicos (bater√≠as, placas). Regulados por <strong class="text-gray-800">RD 208/2005</strong>. Se entregan a <strong class="text-gray-800">gestores autorizados</strong>.</li>
                            </ul>
                        </div>
                    </section>
                </div>

            </section>
        </main>

        <footer class="mt-12 text-center text-sm text-gray-400">
            <p>&copy; Proyecto de documentaci√≥n M2T. Acceso abierto.</p>
        </footer>
    </div>

<script>
    
    // --- CONFIGURACI√ìN Y FUNCIONES BASE DEL API GEMINI ---
    const API_URL_GEMINI = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
    
    // NOTA IMPORTANTE: Esta clave se inyecta autom√°ticamente en el entorno de Canvas.
    // Si ejecutas el archivo localmente o fuera de este entorno, puedes pegar tu clave
    // personal en el campo de texto opcional en la interfaz para que funcione.
    const API_KEY = ""; 
    
    /**
     * Llama al API de Gemini con manejo de reintentos y configuraci√≥n din√°mica.
     * @param {string} userQuery - La pregunta del usuario.
     * @param {string} systemPrompt - Instrucci√≥n para el modelo.
     * @param {boolean} useGrounding - Si debe usar Google Search (grounding).
     * @param {string} localApiKey - Clave pegada por el usuario en el input (si existe).
     * @returns {Promise<{text: string, sources: Array<{uri: string, title: string}>}>}
     */
    async function callGeminiApi(userQuery, systemPrompt, useGrounding, localApiKey) {
        
        // Determinar qu√© clave usar: la inyectada por el entorno o la pegada por el usuario
        const keyToUse = API_KEY || localApiKey;

        if (!keyToUse) {
            throw new Error("Clave de API de Gemini no proporcionada. Por favor, pega tu clave en el campo 'Clave API de Gemini' para usar esta funci√≥n fuera del entorno Canvas.");
        }
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            tools: useGrounding ? [{ "google_search": {} }] : undefined,
        };

        const maxRetries = 3;
        let attempt = 0;

        while (attempt < maxRetries) {
            try {
                const response = await fetch(`${API_URL_GEMINI}${keyToUse}`, { // Usa keyToUse aqu√≠
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Intento de capturar errores espec√≠ficos (ej. 400 Bad Request, 403 Forbidden)
                    const errorBody = await response.text();
                    console.error("Error API response:", response.status, errorBody);
                    if (response.status === 400 || response.status === 403) {
                         throw new Error(`Error en la llamada a la API (${response.status}). La clave podr√≠a ser inv√°lida o el formato de la petici√≥n incorrecto.`);
                    }
                    throw new Error(`Error HTTP! Estado: ${response.status}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (useGrounding && groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); 
                    }
                    return { text, sources };

                } else {
                    throw new Error("Respuesta del modelo incompleta o vac√≠a.");
                }

            } catch (error) {
                console.error(`Attempt ${attempt + 1} failed:`, error);
                attempt++;
                if (attempt < maxRetries) {
                    const delay = Math.pow(2, attempt) * 1000; // Exponential backoff (1s, 2s, 4s)
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    throw new Error(`Error al conectar con el servicio Gemini despu√©s de ${maxRetries} intentos.`);
                }
            }
        }
    }

    /**
     * Funci√≥n que renderiza el Markdown b√°sico a HTML para mejorar la legibilidad.
     * Soporta negritas (**) y saltos de l√≠nea (\n).
     * @param {string} markdownText - Texto en formato Markdown.
     * @returns {string} Texto en formato HTML.
     */
    function renderMarkdownToHtml(markdownText) {
        if (!markdownText) return '';
        
        // Convertir negritas (**) a <strong>
        let htmlText = markdownText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Manejo b√°sico de listas si el texto empieza con guiones y saltos de l√≠nea
        let listItems = htmlText.match(/^- (.*)$/gm);
        if (listItems) {
            // Reemplaza los guiones de lista con <li> y envuelve en <ul>
            htmlText = '<ul>' + listItems.map(item => `<li><i class="ph ph-dot-fill text-lg mr-1 inline-block align-middle"></i>${item.substring(2)}</li>`).join('') + '</ul>';
        } else {
            // Si no hay listas, convertir saltos de l√≠nea a <br>
             htmlText = htmlText.replace(/(\r\n|\n|\r)/g, '<br>');
        }
        
        // Asegurar que el texto entre bloques de lista sigue usando <br> si es necesario
        // (Esto es una soluci√≥n simple para mantener la legibilidad)
        htmlText = htmlText.replace(/<\/ul>\s*(\r\n|\n|\r)/g, '</ul><br>');

        return htmlText;
    }


    // --- MANEJO DE FEATURES UT1 Y UT9 ---

    document.addEventListener('DOMContentLoaded', () => {
        initializeTabs();
        setupGeminiFeatures();
    });

    function setupGeminiFeatures() {
        // UT1 Elements
        const localApiKeyUt1 = document.getElementById('local-api-key-ut1');
        const explanationInput = document.getElementById('explanation-input');
        const explanationButton = document.getElementById('generate-explanation-btn');
        const explanationResult = document.getElementById('explanation-result');
        const explanationLoader = document.getElementById('explanation-loader');

        // UT9 Elements
        const localApiKeyUt9 = document.getElementById('local-api-key-ut9');
        const regulationInput = document.getElementById('regulation-input');
        const regulationButton = document.getElementById('generate-regulation-btn');
        const regulationResult = document.getElementById('regulation-result');
        const regulationLoader = document.getElementById('regulation-loader');
        
        // Listener para Explicaci√≥n Avanzada (UT1)
        explanationButton.addEventListener('click', () => handleAdvancedExplanation(explanationInput, explanationResult, explanationLoader, localApiKeyUt1.value.trim()));
        explanationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleAdvancedExplanation(explanationInput, explanationResult, explanationLoader, localApiKeyUt1.value.trim());
            }
        });

        // Listener para Asesor de Normativa (UT9)
        regulationButton.addEventListener('click', () => handleRegulationAdvisor(regulationInput, regulationResult, regulationLoader, localApiKeyUt9.value.trim()));
        regulationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleRegulationAdvisor(regulationInput, regulationResult, regulationLoader, localApiKeyUt9.value.trim());
            }
        });
    }

    async function handleAdvancedExplanation(inputElement, resultElement, loaderElement, localApiKey) {
        const query = inputElement.value.trim();
        if (!query) {
            resultElement.innerHTML = `<p class="text-red-500 font-semibold">Por favor, introduce un concepto para explicar.</p>`;
            return;
        }

        // 1. Mostrar estado de carga
        resultElement.innerHTML = '';
        loaderElement.classList.remove('hidden');

        const systemPrompt = "Act√∫a como un profesor experto en sistemas de seguridad electr√≥nica (UT1). Proporciona una explicaci√≥n concisa, bien estructurada con saltos de l√≠nea y utilizando **Markdown para negritas** en los t√©rminos t√©cnicos importantes. La respuesta debe tener un tono profesional y centrarse en la definici√≥n y funci√≥n del concepto.";
        
        try {
            const { text } = await callGeminiApi(query, systemPrompt, false, localApiKey);

            // 2. Renderizar y Mostrar resultado
            const formattedText = renderMarkdownToHtml(text);
            
            resultElement.innerHTML = `
                <h4 class="font-bold text-lg mb-2 text-orange-700">${query.toUpperCase()}</h4>
                <div class="markdown-content">${formattedText}</div>
            `;
        } catch (error) {
            // 3. Manejar error
            resultElement.innerHTML = `<p class="text-red-500 font-semibold">Error al generar la explicaci√≥n. Int√©ntalo de nuevo. (${error.message})</p>`;
        } finally {
            // 4. Ocultar cargador
            loaderElement.classList.add('hidden');
        }
    }


    async function handleRegulationAdvisor(inputElement, resultElement, loaderElement, localApiKey) {
        const query = inputElement.value.trim();
        if (!query) {
            resultElement.innerHTML = `<p class="text-red-500 font-semibold">Por favor, introduce una pregunta sobre normativa o PRL.</p>`;
            return;
        }

        // 1. Mostrar estado de carga
        resultElement.innerHTML = '';
        loaderElement.classList.remove('hidden');

        const englishQuery = translateToEnglishForSearch(query); 
        const combinedQuery = `Consulta sobre normativa espa√±ola de seguridad electr√≥nica o PRL: "${query}" / English query: "${englishQuery}"`;

        const systemPrompt = "Act√∫a como un consultor especialista en normativas espa√±olas (REBT, Ley de Seguridad Privada, PRL). Bas√°ndote EXCLUSIVAMENTE en la informaci√≥n encontrada, responde de forma profesional, concisa y **bien formateada con Markdown (saltos de l√≠nea, negritas en t√©rminos legales/decretos)**. Responde en espa√±ol y cita las fuentes utilizadas al final.";
        
        try {
            const { text, sources } = await callGeminiApi(combinedQuery, systemPrompt, true, localApiKey);

            // 2. Renderizar y Mostrar resultado
            const formattedText = renderMarkdownToHtml(text);
            
            let sourceHtml = sources.length > 0 
                ? '<div class="mt-4 pt-3 border-t border-gray-200"><p class="font-bold text-sm mb-1 text-gray-600">Fuentes Consultadas:</p><ul class="list-disc list-inside text-xs text-gray-500 space-y-1">' + 
                  sources.slice(0, 3).map(s => `<li><a href="${s.uri}" target="_blank" class="text-blue-500 hover:underline">${s.title}</a></li>`).join('') + 
                  '</ul></div>'
                : '';

            resultElement.innerHTML = `
                <h4 class="font-bold text-lg mb-2 text-orange-700">Respuesta a: "${query}"</h4>
                <div class="markdown-content">${formattedText}</div>
                ${sourceHtml}
            `;
        } catch (error) {
            // 3. Manejar error
            resultElement.innerHTML = `<p class="text-red-500 font-semibold">Error al consultar la normativa. Verifica la clave o intenta con otra pregunta. (${error.message})</p>`;
        } finally {
            // 4. Ocultar cargador
            loaderElement.classList.add('hidden');
        }
    }

    function translateToEnglishForSearch(text) {
        // Simple, quick translation logic for common Spanish terms to aid search grounding
        const translations = {
            "ley de seguridad privada": "Private Security Law Spain",
            "rebt": "Low Voltage Electrotechnical Regulation Spain",
            "prl": "Occupational Risk Prevention Spain",
            "grado 4": "Grade 4 security system requirements Spain",
            "grado 3": "Grade 3 security system requirements Spain",
            "ict": "Common Telecommunications Infrastructure Regulation Spain",
            "certificado de instalacion": "installation certificate requirements Spain",
            "cinco reglas de oro": "five golden rules electrical safety",
            "raee": "WEEE management Spain",
            "toma de tierra": "earthing requirements"
        };
        let lowerText = text.toLowerCase();
        let englishText = lowerText;
        for (const [spanish, english] of Object.entries(translations)) {
            englishText = englishText.replace(spanish, english);
        }
        return englishText;
    }


    // --- MANEJO DE PESTA√ëAS Y FUNCIONALIDADES DE UI ---

    // Datos para el detalle interactivo del proyecto (UT9)
    const projectData = {
        memoria: {
            title: "Memoria Descriptiva (Detalle Ampliado) üìù",
            description: "Justifica la elecci√≥n del sistema, describe el entorno a proteger, el <span class=\"font-semibold text-blue-800\">grado de seguridad</span> aplicado, y los <span class=\"font-semibold text-blue-800\">c√°lculos t√©cnicos</span> que respaldan el dise√±o (como c√°lculo de <span class=\"font-semibold text-blue-800\">ca√≠da de tensi√≥n</span> y dimensionamiento de bater√≠as de reserva)."
        },
        planos: {
            title: "Planos y Esquemas (Detalle Ampliado) üó∫Ô∏è",
            description: "Incluye el <span class=\"font-semibold text-blue-800\">plano de situaci√≥n</span> (localizaci√≥n del inmueble), <span class=\"font-semibold text-blue-800\">planos de emplazamiento</span> (ubicaci√≥n de c√°maras, detectores, central), los <span class=\"font-semibold text-blue-800\">esquemas unifilares</span> de las conexiones y el detalle constructivo de las <span class=\"font-semibold text-blue-800\">canalizaciones</span>."
        },
        pliego: {
            title: "Pliego de Condiciones (Reglas y Calidad) üìë",
            description: "Detalla las <span class=\"font-semibold text-blue-800\">caracter√≠sticas m√≠nimas</span> que deben cumplir los materiales (homologaciones), la forma en que se deben realizar las <span class=\"font-semibold text-blue-800\">pruebas de funcionamiento</span> y la garant√≠a exigida por la normativa al instalador."
        }
    };

    window.showProjectDetail = function(itemId) {
        const info = projectData[itemId];
        const detailPanel = document.getElementById('project-detail');
        detailPanel.innerHTML = `
            <div class="text-left">
                <h3 class="font-bold text-xl mb-2 text-yellow-700">${info.title}</h3>
                <p class="text-gray-700">${info.description}</p>
            </div>
        `;
    };

    function setActiveMainTab(targetId) {
        const mainNavLinks = document.querySelectorAll('.main-nav-link');
        const mainContentSections = document.querySelectorAll('.main-content-section');

        mainNavLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.target === targetId);
        });
        mainContentSections.forEach(section => {
            section.classList.toggle('active', section.id === `${targetId}-section`);
        });
    }

    function setActiveSubTab(targetId) {
        const subNavLinks = document.querySelectorAll('.sub-nav-link');
        const subContentSections = document.querySelectorAll('#ut9-content-container .content-section');

        subNavLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.target === targetId);
        });
        subContentSections.forEach(section => {
            section.classList.toggle('active', section.id === `${targetId}-section`);
        });
    }

    function initializeTabs() {
        // Inicializar Pesta√±as Principales (UT1 y UT9)
        document.querySelectorAll('.main-nav-link').forEach(link => {
            link.addEventListener('click', () => {
                setActiveMainTab(link.dataset.target);
            });
        });

        // Inicializar Pesta√±as Secundarias (Dentro de UT9)
        document.querySelectorAll('.sub-nav-link').forEach(link => {
            link.addEventListener('click', () => {
                setActiveSubTab(link.dataset.target);
            });
        });
        
        // Establecer la primera pesta√±a activa por defecto (UT1 y Marco Legal)
        setActiveMainTab('ut1');
        setActiveSubTab('ut9-marco-legal'); 
        
        // Mostrar el contenido principal ya que no hay login
        document.getElementById('main-content').classList.remove('hidden');
        
        // Simular clic inicial en un componente de proyecto
        showProjectDetail('memoria');
    }
    
</script>

</body>
</html>